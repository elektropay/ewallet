<?
###############################################################################
# PROGRAM     : EPAY ENTERPRISE                                               #
# VERSION     : 4.13                                                          #
# AUTHOR      : DMITRY PEREUDA                                                #

# COMPANY     : ALSTRASOFT	                                              #
# COPYRIGHTS  : (C)2009 ALSTRASOFT. ALL RIGHTS RESERVED                       #
#         COPYRIGHTS BY (C)2009 ALSTRASOFT. ALL RIGHTS RESERVDED  	      #
# LICENSE KEY : C3FA-76A1-83A4-C2B4-AE1F-1D5A-14ED-1DCA                       #
###############################################################################
#    THIS FILE IS PART OF EPAY SCRIPT - THE NEW UNIVERSAL PAYMENT GATEWAY     #
#               	     DEVELOPED BY ALSTRASOFT                          #
###############################################################################
#    ALL SOURCE CODE, IMAGES, PROGRAMS, FILES INCLUDED IN THIS DISTRIBUTION   #
#         COPYRIGHTS BY (C)2009 ALSTRASOFT. ALL RIGHTS RESERVDED  	      #
###############################################################################
#       ANY REDISTRIBUTION WITHOUT PERMISSION OF ALSTRASOFT AND IS            #
#                            STRICTLY FORBIDDEN                               #
###############################################################################
#         COPYRIGHTS BY (C)2009 ALSTRASOFT. ALL RIGHTS RESERVDED  	      #
###############################################################################


#         COPYRIGHTS BY (C)2009 ALSTRASOFT. ALL RIGHTS RESERVDED  	      #





###############################################################################
$data['PageName']='MEMBERS INFORMATION OVERVIEW';
$data['PageFile']='members';
###############################################################################
include('../config.htm');
###############################################################################
if(!$_SESSION['adm_login']){
        header("Location:{$data['Admins']}/login.htm");
        echo('ACCESS DENIED.');
        exit;
}

if($post['save'])
{  

  ################### Deposite option  ###################
  
    $depositeData=array();
     if(isset($_POST['creditcard'])){
    $depositeData['creditcard']=1;
    }
    else {
     $depositeData['creditcard']=0;
     }
    if(isset($_POST['paypal'])){
    $depositeData['paypal']=1;
    }
    else {
     $depositeData['paypal']=0;
     }
    if(isset($_POST['stormpay'])){
    $depositeData['stormpay']=1;
    } 
    else {
       $depositeData['stormpay']=0;
     }
    if(isset($_POST['netpay'])){
    $depositeData['netpay']=1;
    } 
    else {
     $depositeData['netpay']=0;
     }
    
    if(isset($_POST['egold'])){
    $depositeData['egold']=1;
    } 
    else {
        $depositeData['egold']=0;
    }
    
     if(isset($_POST['moneybookers'])){
    $depositeData['moneybookers']=1;
    } 
    else {
        $depositeData['moneybookers']=0;
    }
     if(isset($_POST['intgold'])){
    $depositeData['intgold']=1;
    } 
    else {
        $depositeData['intgold']=0;
    }
    if(isset($_POST['ebullion'])){
    $depositeData['ebullion']=1;
    } 
    else {
        $depositeData['ebullion']=0;
    }
    if(isset($_POST['pecunix'])){
    $depositeData['pecunix']=1;
    } 
    else {
        $depositeData['pecunix']=0;
    }
    if(isset($_POST['epaydirect'])){
    $depositeData['epaydirect']=1;
    } 
    else {
        $depositeData['epaydirect']=0;
    }
    if(isset($_POST['evocash'])){
    $depositeData['evocash']=1;
    } 
    else {
        $depositeData['evocash']=0;
    }
    if(isset($_POST['qchex'])){
    $depositeData['qchex']=1;
    } 
    else {
        $depositeData['qchex']=0;
    }
    if(isset($_POST['virtualgold'])){
    $depositeData['virtualgold']=1;
    } 
    else {
        $depositeData['virtualgold']=0;
    }
    if(isset($_POST['goldmoney'])){
    $depositeData['goldmoney']=1;
    } 
    else {
        $depositeData['goldmoney']=0;
    }
    if(isset($_POST['autorize'])){
    $depositeData['autorize']=1;
    } 
    else {
        $depositeData['autorize']=0;
    }
     if(isset($_POST['checkout'])){
    $depositeData['checkout']=1;
    } 
    else {
        $depositeData['checkout']=0;
    }
     if(isset($_POST['echeck'])){
    $depositeData['echeck']=1;
    } 
    else {
        $depositeData['echeck']=0;
    }
     if(isset($_POST['mail'])){
    $depositeData['mail']=1;
    } 
    else {
        $depositeData['mail']=0;
    }
    
    
   ################### Widthdraw option  ###################
      $WidthdrawData=array();
     
    if(isset($_POST['w_paypal'])){
    $WidthdrawData['paypal']=1;
    }
    else {
     $WidthdrawData['paypal']=0;
     }
    if(isset($_POST['w_stormpay'])){
    $WidthdrawData['stormpay']=1;
    } 
    else {
       $WidthdrawData['stormpay']=0;
     }
    if(isset($_POST['w_netpay'])){
    $WidthdrawData['netpay']=1;
    } 
    else {
     $WidthdrawData['netpay']=0;
     }
    
    if(isset($_POST['w_egold'])){
    $WidthdrawData['egold']=1;
    } 
    else {
     $WidthdrawData['egold']=0;
    }
    
     if(isset($_POST['w_moneybookers'])){
    $WidthdrawData['moneybookers']=1;
    } 
    else {
        $WidthdrawData['moneybookers']=0;
    }
     if(isset($_POST['w_intgold'])){
    $WidthdrawData['intgold']=1;
    } 
    else {
        $WidthdrawData['intgold']=0;
    }
    if(isset($_POST['w_ebullion'])){
    $WidthdrawData['ebullion']=1;
    } 
    else {
        $WidthdrawData['ebullion']=0;
    }
    if(isset($_POST['w_pecunix'])){
    $WidthdrawData['pecunix']=1;
    } 
    else {
        $WidthdrawData['pecunix']=0;
    }
    if(isset($_POST['w_epaydirect'])){
    $WidthdrawData['epaydirect']=1;
    } 
    else {
        $WidthdrawData['epaydirect']=0;
    }
    if(isset($_POST['w_evocash'])){
    $WidthdrawData['evocash']=1;
    } 
    else {
       $WidthdrawData['evocash']=0;
    }
    if(isset($_POST['w_goldmoney'])){
    $WidthdrawData['goldmoney']=1;
    } 
    else {
        $WidthdrawData['goldmoney']=0;
    }
    if(isset($_POST['w_virtualgold'])){
    $WidthdrawData['virtualgold']=1;
    } 
    else {
        $WidthdrawData['virtualgold']=0;
    }
    if(isset($_POST['w_payemo'])){
    $WidthdrawData['payemo']=1;
    } 
    else {
        $WidthdrawData['payemo']=0;
    }
    
    if(isset($_POST['w_bwire'])){
    $WidthdrawData['bwire']=1;
    } 
    else {
        $WidthdrawData['bwire']=0;
    }
    
     if(isset($_POST['w_echeck'])){
     $WidthdrawData['echeck']=1;
     } 
    else {
        $WidthdrawData['echeck']=0;
    }
     if(isset($_POST['w_western'])){
    $WidthdrawData['western']=1;
    } 
    else {
        $WidthdrawData['western']=0;
    }
    
     if(isset($_POST['w_moneygram'])){
    $WidthdrawData['moneygram']=1;
    } 
    else {
        $WidthdrawData['moneygram']=0;
    }
    
   
    setUserPermission($uid,$depositeData,$WidthdrawData);
   
   header("location: members.htm?id=".$_GET['id']."&action=detail&type=active&page=0");
   exit;
  
}
###############################################################################
$data[permissionCheck]= getUserPermission($_GET['id']);
 

###############################################################################
if(!$post['action'])$post['action']='select';
###############################################################################
if($post['action']=='suspend'||$post['action']=='activate'){
        set_member_status($post['gid'], $post['action']=='activate'?true:false);
        $post['action']='select';
}elseif($post['action']=='delete'){
        delete_member($post['gid']);
        $post['action']='select';
}elseif($post['action']=='delemail'){
        delete_email_info($post['bid']);
        $post['action']='detail';
}elseif($post['action']=='setdefault'){
        set_default_email($post['bid']);
        $post['action']='detail';
}elseif($post['action']=='sendemail'){
        send_email_request($post['bid']);
        $post['action']='detail';
}elseif($post['action']=='delete_card'){
        delete_card($post['bid']);
        $post['action']='detail';
}elseif($post['action']=='delete_bank'){
        delete_bank($post['bid']);
        $post['action']='detail';
}elseif($post['action']=='insert'||$post['action']=='update'){
        $post['PostSent']=false;
        $data['Sponsors']=get_sponsors($post['gid']);
        if($post['action']=='update')$post=select_info($post['gid'], $post);
        if($post['send']){
                if($post['action']=='insert'&&!is_user_available($post['username'])){
                        $data['Error']='Sorry but this username already taken.';
                }elseif(!$post['username']){
                        $data['Error']='Please enter member username.';
                }elseif(!$post['password']){
                        $data['Error']='Please enter member password.';
                }elseif(!$post['fname']){
                        $data['Error']='Please enter your first name.';
                }elseif(!$post['lname']){
                        $data['Error']='Please enter your last name.';
                }elseif(!$post['address']){
                        $data['Error']='Please enter address where you live.';
                }elseif(!$post['city']){
                        $data['Error']='Please enter city where you live.';
                }elseif(!$post['country']){
                        $data['Error']='Please enter country where you live.';
                }elseif(!$post['zip']){
                        $data['Error']='Please enter your postal code.';
                }elseif(!$post['phone']){
                        $data['Error']='Please enter your telephone number.';
                }else{
                        if($post['action']=='insert'){
                                $post['gid']=$post['id']=insert_profile_info($post);
                        }else{
                                update_private_info($post, $post['gid']);
                                update_profile_info($post, $post['gid'], false);
                        }
                        //update_card_info($post, $post['gid'], false);
                        //update_bank_info($post, $post['gid'], false);
                        $post['PostSent']=true;
                }
        }elseif($post['cancel']){
                $post['action']='select';
        }
}elseif($post['action']=='insert_card'||$post['action']=='update_card'){
        $post['PostSent']=false;
        if($post['action']=='update_card'){
           $card=select_cards($post['gid'], false, $post['bid'], true);
           if($card)foreach($card[0] as $key=>$value)if(!$post[$key])$post[$key]=$value;
        }
        if($post['send']){
                if(!$post['ctype']){
                        $data['Error']='Please choose your credit card type.';
                }elseif(!$post['cname']){
                        $data['Error']='Please enter your full name from credit card.';
                }elseif(!$post['cnumber']||!is_number($post['cnumber'])){
                        $data['Error']='Please enter your valid credit card number.';
                }elseif(!$post['ccvv']||!is_number($post['ccvv'])){
                        $data['Error']='Please enter your valid credit card CVV number.';
                }elseif(!$post['cmonth']){
                        $data['Error']='Please choose month for expired date.';
                }elseif(!$post['cyear']){
                        $data['Error']='Please choose year for expired date.';
                }else{
                        if($post['action']=='insert_card'){
                                $post['bid']=insert_card_info($post, $post['gid']);
                        }else{
                                update_card_info($post, $post['bid'], $post['gid']);
                        }
                        $post['PostSent']=true;
                }
        }elseif($post['cancel']){
                $post['action']='detail';
        }
}elseif($post['action']=='insert_bank'||$post['action']=='update_bank'){
        $post['PostSent']=false;
        if($post['action']=='update_bank'){
           $bank=select_banks($post['gid'], $post['bid'], true);
           if($bank)foreach($bank[0] as $key=>$value)if(!$post[$key])$post[$key]=$value;
        }
        if($post['send']){
                if(!$post['bname']){
                        $data['Error']='Please enter name of your bank.';
                }elseif(!$post['baddress']){
                        $data['Error']='Please enter address of your bank.';
                }elseif(!$post['bcity']){
                        $data['Error']='Please enter city of your bank.';
                }elseif(!$post['bzip']){
                        $data['Error']='Please enter postal code of your bank.';
                }elseif(!$post['bcountry']){
                        $data['Error']='Please choose country of your bank.';
                }elseif(!$post['bphone']){
                        $data['Error']='Please enter telephone number of your bank.';
                }elseif(!$post['bnameacc']){
                        $data['Error']='Please enter account name.';
                }elseif(!$post['baccount']){
                        $data['Error']='Please enter account number.';
                }else{
                        if($post['action']=='insert_bank'){
                                $post['bid']=insert_bank_info($post, $post['gid']);
                        }else{
                                update_bank_info($post, $post['bid'], $post['gid']);
                        }
                        $post['PostSent']=true;
                }
        }elseif($post['cancel']){
                $post['action']='detail';
        }
}elseif($post['action']=='cancel'){
        $post['action']='select';
}

elseif($_GET['action']=='verify'){
   $gid=$_GET['id'];
   db_query("update dp_members set status='1' where id='$gid'");
   $post['action']='detail';

}elseif($_GET['action']=='certify'){
   $gid=$_GET['id'];
   db_query("update dp_members set status='2' where id='$gid'");
   $post['action']='detail';
}elseif($_GET['action']=='unverify'){
   $gid=$_GET['id'];
   db_query("update dp_members set status='0' where id='$gid'");
   $post['action']='detail';
}
###############################################################################
elseif($_GET['action']=='close'){
   $gid=$_GET['id'];
   db_query("update dp_members set active='2' where id='$gid'");

}
if($post['action']=='detail'){
        $post['MemberInfo']=get_member_info($post['gid']);
        //$post['MemberInfo']['email']=prnmemberemails($post['gid']);
        if($post['MemberInfo']['sponsor']){
                /*$post['MemberInfo']['sponsor']=
                        get_member_username($post['MemberInfo']['sponsor'])." (".
                        get_member_email($post['MemberInfo']['sponsor']).")"
                ;*/
                $post['MemberInfo']['sname']=get_member_username($post['MemberInfo']['sponsor']);
                $post['MemberInfo']['smail']=get_member_email($post['MemberInfo']['sponsor']);
        }else $post['MemberInfo']['semail']='N/A';
        
        $post['MemberInfo']['balance']=select_balance($post['gid']);
        $post['CardsInfo']=select_cards($post['gid'], false);
        $post['BanksInfo']=select_banks($post['gid']);
}
###############################################################################
if($post['action']=='select'){
        $status=$post['type']=='active'?1:0;
        $data['MembersCount']=get_members_count($status);
        for($i=0; $i<$data['MembersCount']; $i+=$data['MaxRowsByPage'])$data['Pages'][]=$i;
        if($post['type']=='online'){
                $data['MembersList']=get_members_list(1, $post['StartPage'], $data['MaxRowsByPage'], true);
        }elseif($post['type']=='closed'){
                $data['MembersList']=get_members_list(2, $post['StartPage'], $data['MaxRowsByPage']);
        }else{
                $data['MembersList']=get_members_list($status, $post['StartPage'], $data['MaxRowsByPage']);
        }
}
###############################################################################
if($post['action']=='creditcard'){
       
       $data['CreditCardList']=getcreditcard_user();
      
     
}
###############################################################################
if($post['action']=='search'){
 $data['PageFile']='search';
 $data['PageName']='MEMBERS SEARCH';
 if (isset($post['keyword']) && !empty($post['keyword']) && isset($post['sfield']) && !empty($post['sfield'])) {
  $fieldname = "lname";
  switch ($post['sfield']) {
    case "un":
      $fieldname = "username";
      break;
    case "em":
      $fieldname = "email";
      break;
    case "fn":
      $fieldname = "fname";
      break;
    case "ln":
      $fieldname = "lname";
      break;
  }
  $post['action'] = 'select';
  $post['type'] = 'found';
  $data['PageFile']='members';
  $where_pred = " UPPER(`$fieldname`) LIKE UPPER('%{$post['keyword']}%') ";
  $data['MembersCount']=get_members_count_where_pred($where_pred);
        for($i=0; $i<$data['MembersCount']; $i+=$data['MaxRowsByPage'])$data['Pages'][]=$i;
        $data['MembersList']=get_members_list_where_pred($post['StartPage'], $data['MaxRowsByPage'], $where_pred);
 }
}
###############################################################################
$data['SystemBalance']=select_balance(-1);
###############################################################################
display('admins');
###############################################################################
?>